# HIL Scheduler Configuration

general:
  log_level: INFO

time:
  timezone: "Europe/Madrid"

schedule:
  source_csv: "schedule_source.csv"
  duration_h: 0.5
  default_resolution_min: 5

startup:
  schedule_source: "manual"    # manual | api
  transport_mode: "local"      # local | remote
  initial_soc_pu: 0.5          # shared local-emulation startup SoC for all plants

istentore_api:
  base_url: "https://3mku48kfxf.execute-api.eu-south-2.amazonaws.com/default"
  email: "i-STENTORE"
  tomorrow_poll_start_time: "15:00"  # gates polling for next-day schedule only (today is fetched whenever missing)
  schedule_period_minutes: 15
  post_measurements_in_api_mode: true
  measurement_post_period_s: 60
  measurement_post_queue_maxlen: 2000
  measurement_post_retry_initial_s: 2
  measurement_post_retry_max_s: 60

timing:
  data_fetcher_period_s: 120
  scheduler_period_s: 2
  plant_period_s: 2
  measurement_period_s: 2
  measurements_write_period_s: 60

recording:
  compression:
    enabled: true
    max_kept_gap_s: 360  # compression keep-gap threshold (not the sampling period)
    tolerances:
      p_setpoint_kw: 0.0
      battery_active_power_kw: 0.1
      q_setpoint_kvar: 0.0
      battery_reactive_power_kvar: 0.1
      soc_pu: 0.001
      p_poi_kw: 0.1
      q_poi_kvar: 0.1
      v_poi_kV: 0.001

plants:
  lib:
    name: "LIB"
    model:
      capacity_kwh: 500.0
      power_limits:
        p_max_kw: 1000.0
        p_min_kw: -1000.0
        q_max_kvar: 600.0
        q_min_kvar: -600.0
      poi_voltage_kv: 20.0
    modbus:
      local:
        host: "localhost"
        port: 5020
        byte_order: big
        word_order: msw_first
        points:
          p_setpoint: {address: 86, format: int16, access: rw, unit: kW, eng_per_count: 0.1}
          p_poi: {address: 290, format: int16, access: r, unit: kW, eng_per_count: 0.1}
          p_battery: {address: 270, format: int16, access: r, unit: kW, eng_per_count: 0.1}
          q_setpoint: {address: 88, format: int16, access: rw, unit: kvar, eng_per_count: 0.1}
          q_poi: {address: 292, format: int16, access: r, unit: kvar, eng_per_count: 0.1}
          q_battery: {address: 272, format: int16, access: r, unit: kvar, eng_per_count: 0.1}
          v_poi: {address: 296, format: uint16, access: r, unit: V, eng_per_count: 1.0}
          enable: {address: 1, format: uint16, access: rw, unit: raw, eng_per_count: 1.0}
          soc: {address: 281, format: uint16, access: r, unit: pu, eng_per_count: 0.0001} # pc is percentage
          stop_command: {address: 85, format: uint16, access: w, unit: raw, eng_per_count: 1.0}
      remote:
        host: "10.117.133.21"
        port: 502
        byte_order: big
        word_order: msw_first
        points:
          p_setpoint: {address: 86, format: int16, access: rw, unit: kW, eng_per_count: 0.1}
          p_poi: {address: 290, format: int16, access: r, unit: kW, eng_per_count: 0.1}
          p_battery: {address: 270, format: int16, access: r, unit: kW, eng_per_count: 0.1}
          q_setpoint: {address: 88, format: int16, access: rw, unit: kvar, eng_per_count: 0.1}
          q_poi: {address: 292, format: int16, access: r, unit: kvar, eng_per_count: 0.1}
          q_battery: {address: 272, format: int16, access: r, unit: kvar, eng_per_count: 0.1}
          v_poi: {address: 296, format: uint16, access: r, unit: V, eng_per_count: 1.0}
          enable: {address: 1, format: uint16, access: rw, unit: raw, eng_per_count: 1.0} # El enable permite la escritura en la batería. Debe estar a 1 para permitir escritura
          soc: {address: 281, format: uint16, access: r, unit: pu, eng_per_count: 0.0001} # pc is percentage
          stop_command: {address: 85, format: int16, access: w, unit: raw, eng_per_count: 1.0} # 1: stop, 0: start. Este registro debe estar a 0 para permitir la operación normal de la batería. Si se pone a 1, la batería se detiene y no responde a comandos de potencia.
    measurement_series:
      soc: 4
      p: 6
      q: 7
      v: 8

  vrfb:
    name: "VRFB"
    model:
      capacity_kwh: 400
      power_limits:
        p_max_kw: 160
        p_min_kw: -160
        q_max_kvar: 64
        q_min_kvar: -64
      poi_voltage_kv: 0.22
    modbus:
      local:
        host: "localhost"
        port: 5021
        byte_order: big
        word_order: msw_first
        points:
          p_setpoint: {address: 1, format: int16, access: rw, unit: kW, eng_per_count: 0.1}
          p_poi: {address: 14, format: int16, access: r, unit: kW, eng_per_count: 0.1}
          p_battery: {address: 14, format: int16, access: r, unit: kW, eng_per_count: 0.1}
          q_setpoint: {address: 2, format: int16, access: rw, unit: kvar, eng_per_count: 0.1}
          q_poi: {address: 15, format: int16, access: r, unit: kvar, eng_per_count: 0.1}
          q_battery: {address: 15, format: int16, access: r, unit: kvar, eng_per_count: 0.1}
          v_poi: {address: 29, format: uint16, access: r, unit: V, eng_per_count: 1.0}
          enable: {address: 7, format: uint16, access: rw, unit: raw, eng_per_count: 1.0}
          soc: {address: 22, format: uint16, access: r, unit: pu, eng_per_count: 0.0001} # pc is percentage
          start_command: {address: 5, format: uint16, access: w, unit: raw, eng_per_count: 1.0} # 2: start, 0: stop. Este registro debe estar a 2 para permitir la operación normal de la batería. Si se pone a 0, la batería se detiene y no responde a comandos de potencia.
      remote:
        host: "10.117.133.26"
        port: 502
        byte_order: big
        word_order: msw_first
        points:
          p_setpoint: {address: 1, format: int16, access: rw, unit: kW, eng_per_count: 0.1}
          p_poi: {address: 14, format: int16, access: r, unit: kW, eng_per_count: 0.1} # Mismo que p_battery porque no hay impedancia entre inversor y POI
          p_battery: {address: 14, format: int16, access: r, unit: kW, eng_per_count: 0.1}
          q_setpoint: {address: 2, format: int16, access: rw, unit: kvar, eng_per_count: 0.1}
          q_poi: {address: 15, format: int16, access: r, unit: kvar, eng_per_count: 0.1} # Igual que para p_poi
          q_battery: {address: 15, format: int16, access: r, unit: kvar, eng_per_count: 0.1}
          v_poi: {address: 29, format: uint16, access: r, unit: V, eng_per_count: 1.0}
          enable: {address: 7, format: uint16, access: rw, unit: raw, eng_per_count: 1.0}
          soc: {address: 22, format: uint16, access: r, unit: pu, eng_per_count: 0.0001} # pc is percentage
          start_command: {address: 5, format: uint16, access: w, unit: raw, eng_per_count: 1.0} # 2: start, 0: stop. Este registro debe estar a 2 para permitir la operación normal de la batería. Si se pone a 0, la batería se detiene y no responde a comandos de potencia.
    measurement_series:
      soc: 5
      p: 11
      q: 10
      v: 9
